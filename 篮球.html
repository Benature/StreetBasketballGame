<!DOCTYPE html>
<html>
<head>
    <title>街头篮球</title>
    <meta charset="utf-8">
</head>
<body>
<canvas id="myCanvas1" width="1500" height="700" style="border:solid;position: absolute;z-index: 0">
    你的浏览器不支持canvas画布元素，请更新浏览器获得演示效果。
</canvas>

<script type="text/javascript">
    var canvas = document.getElementById("myCanvas1");
    var context = canvas.getContext("2d");
    var canvas_width = document.getElementById("myCanvas1").width
    var canvas_height = document.getElementById("myCanvas1").height
    console.log(canvas_width);
    
    var ball={x:100,y:250,r:40};//篮球ball圆心坐标,半径
    //var ballc = {x:ball.x-ball.r,y:ball.y-ball.r};//篮球ball的圆心c坐标
    var v_x = 0,
        v_y = 1;//球分解速度
    var fre=0.5;//帧率
    var g   = 1;//重力加速度
    var wind_v = 0.0;//台风横向加速度
    var airf  = 0.5;//空气阻力
    var groundy = 600;//地面y值
    var t = 0;//时间(迭代)
    var mouseX,mouseY;//鼠标点击坐标

    var LevelMove;//水平移动真假判断
    var lor;
    var back;
    var propsplace_x1;//小道具的随机xy坐标
    var propsplace_y1 ;
    var propstime = 5;//小道具停留时间；
    var timelonger = 3;//加时时间。
    var propsplace_x2;//保存小道具坐标的变量；
    var propsplace_y2;
    var p_distance;//小道具与球的中心距离；
    var p_draw = true;
    var p_word = false;
    var p_exist = false;
    var propstrigger;
    var t_iplus = 0;//道具加时。
    var t_i,t_itotal,t_i0 ,t_i1;
    var ghost_x = new Array();
    var ghost_y = new Array();
    var shadow_rate = 0;//影子缩放比例
    var gameover = false;//游戏是否结束
    var gamebegin = false;//游戏是否开始
    var backdoor = {clock:false,wind:false}//后门
    

    //键盘后门
    document.addEventListener("keydown", function (e) {
        //console.log("keydown");
        console.log(e.keyCode);
        if (e.keyCode==67){backdoor.clock = true;
            console.log("backdoor: clock")
        }
        else if (e.keyCode==69){gameover = true;
            console.log("backdoor: gameover")
        }
        else if (e.keyCode==87){backdoor.wind = true;
            console.log("backdoor: wind")
        }
        
    }, false);

    //点击鼠标触发弹起
    canvas.addEventListener("mousedown", function (e) {
        //console.log("mousedown");
        var back_y = 1
        v_y = 15;
        mouseX = e.pageX - canvas.clientLeft;
        mouseY = e.pageY - canvas.clientTop;
        //console.log(mouseX + "," + mouseY);
        LevelMove = true;
        back = 1
        lor = (mouseX >= ball.x)?(1):(-1);
        //console.log("lor"+lor);
        v_x = 10;
        //console.log(" now should LEVEL MOVE")
        gamebegin = true;
    }, false);

    //水平移动
    var level_move = function(){
        if (LevelMove) {
            //console.log("LEVEL MOVE!!!")
            ball.x += lor * v_x *fre*back + wind_v*fre;
            v_x -= airf;
            if (v_x <= 0) {LevelMove = false}
        }
        else{
            ball.x += wind_v*0.1
        };
        if (ball.x<-ball.r){ball.x=canvas_width+ball.r-10}
        else if (ball.x>canvas_width+ball.r){ball.x=-ball.r+10}

    };
    //篮球弹跳
    var BBU = function(){
        //Ball Bounce Up
        //篮球自己弹起来
        //ball.y -=  ((v_y * t + 0.5 * g * t*t));
        ball.y -=  ((v_y * fre ));
        v_y -= (g * fre);
        if (ball.y >= groundy){
            //v_y = -v_y-1;
            v_y = 25;
        }
    }
    //篮球残影
    var ghost = function(){
        context.fillStyle = 'rgba(239, 129, 32, 0.1)';
        //记录坐标集合 
        if (t<=1*ball.r){
                ghost_x[t]=ball.x;
                ghost_y[t]=ball.y;
            }
            else{
                //坐标数据迭代退位
                for (var n = 0; n < 1*ball.r; n++){
                    ghost_x[n] = ghost_x[n+1];
                    ghost_y[n] = ghost_y[n+1];
                }
                //末位数据留给最新坐标
                ghost_x[1*ball.r]=ball.x;
                ghost_y[1*ball.r]=ball.y;
            }
            //画残影
            for (var i = 0; i <= ball.r; i++){
                context.beginPath();
                for (var n = 0; n < 1; n++){
                context.arc(ghost_x[1*i+n],ghost_y[1*i+n],i+1/1*n, 0, 360 * Math.PI / 180, true);
                }
                context.fill();
            }
    }
    //篮球影子
    var shadow = function(){
    //篮球影子
    context.scale(1,0.5);
        context.fillStyle= 'rgba(0,0,0, 0.6)';
        context.beginPath();
        shadow_rate = (ball.y>0)?(0.05*(groundy-ball.y)):(ball.r-5);
        context.arc(ball.x,2* groundy+2*ball.r,(ball.r-shadow_rate), 0, 360*Math.PI/180, true);
        context.closePath();
        context.fill();
        context.scale(1,2);
    }
    //篮球旋转
    var ball_rotate = function(){
        //篮球旋转
        context.translate(ball.x, ball.y);
        context.rotate((Math.PI/180)*t*1)
        context.drawImage(ball_img, 0, 0, 250,250,-ball.r,-ball.r,80,80);
        /*context.beginPath();context.arc(0, 0, 50, 0, 360 * Math.PI / 180, true);context.moveTo(0, 0);context.lineTo(0, 50);context.stroke();*/
        context.rotate(-(Math.PI/180)*t*1)
        context.translate(-ball.x,-ball.y);
    }

    //游戏开始界面
    var begin_interface = function(){
        context.font = "100px Arial";
        context.fillStyle ="black";
        context.fillText("街头土味篮球",100,400);
        context.font = "30px Arial";
        context.fillStyle ="purple";
        context.fillText("点击鼠标以开始",200,500);
    }
    //游戏结束界面
    var end_interface = function(){
        context.font = "50px Arial";
        context.fillStyle ="red";
        context.fillText("GAME OVER",100,100);
    }
    
    //时钟道具特效
    var propsimage = new Image();
    var clock_on = false;
    propsimage.src ="clock.png";
    var prop_clock = function(){
        propstrigger = Math.ceil(Math.random() * 1000);
        //console.log(propstrigger);
        //随机开始道具
        if((propstrigger === t_i || b
        ackdoor.clock)&& !clock_on){
            p_exist = true;
            p_word = false;
            backdoor.clock = false;
            clock_on=true;
            t_i0 = t_i  ;
            //console.log("prop is exist & t_i0="+t_i0) ;   
        }
        //道具出现乱晃
        else if(t_i >= t_i0 - 0.5 && p_exist){
            propsplace_x1 = Math.random() * 200 + 100;//小道具的随机xy坐标
            propsplace_y1 = Math.random() * 200 + 100;
            context.drawImage(propsimage,0,0,300,300,propsplace_x1,propsplace_y1,100,100);
            //console.log("randoming");
        }
        //道具定格,等待触发
        else if((t_i <= t_i0 -0.5) && (t_i >= t_i0 - propstime) && p_exist ){
            p_distance  =  Math.sqrt(Math.pow( ball.x - propsplace_x1,2) + Math.pow(ball.y - propsplace_y1,2) ); 
            if (p_distance >= 100 && p_draw){
                context.drawImage(propsimage,0,0,300,300,propsplace_x1,propsplace_y1,100,100);
            }
            else if (p_distance < 100){p_draw = false}
            
            //道具效果触发
            if (p_draw === false){
            t_iplus += 3;
            t_i1 = t_i;  
            p_word = true;
            p_exist = false;
            p_draw = true;
            //console.log("add time")  
            }
        }
        else if(t_i <= t_i0-propstime-5){clock_on=false;};//道具冷却

        //文字效果
        if (t_i >= t_i1 - 5 && p_word){
            context.strokeStyle ="orange";
            context.font = "30px Arial";
            context.strokeText("加三秒蛤!",propsplace_x1-10,propsplace_y1-10);
            //console.log("print the clock")
        }
        
    }

    //台风效果
    var wind = {
        trigger:0,
        blow:false,
        t:0,//台风触发时间记录
        keep:10,
        on:false
    };
    var prop_wind = function(){
        wind.trigger = Math.ceil(Math.random() * 1000);
        //#wind.trigger = 55;
        if((wind.trigger === t_i ||backdoor.wind) && !wind.on){
            //TODO: 随机速度大小与方向
            wind.blow = true;
            wind.on = true;
            backdoor.wind = false
            wind.t = t_i  ;
        }
        //出现台风
        else if((t_i >= wind.t - wind.keep) && wind.blow ){
            wind_v = 3;//台风风速
            context.fillStyle ="purple";
            context.font = "15px Arial";
            context.fillText("挂台风辣!",200,150);
        }
        else{
            wind.blow = false;
            wind.on = false;
            wind_v = 0;
            console.log("stop wind")
        }
    }

    //篮板碰撞
    var distances = function (x,y){
        distances = ((ball.x+ball.r-x)*(ball.x+ball.r-x))+((ball.y-ball.r-y)*(ball.y-ball.r-y));
        
        return distances; 
        }
    
        var boardbasic = {x:100, y:100};
        var board = {x:500,y:200,w:25,h:200};
        var boardheart = {x:500,y:500}
        var boardket = {x1:1,y1:boardbasic-393,x2:1,y2:1}
        var connerCollision = {c1:false , c2:false}
    var collision = function (){
        //单纯粗糙的碰板
        var between_x=(ball.x + ball.r > board.x) && (ball.x - ball.r < board.x + board.w);
        var between_y=(ball.y + ball.r > board.y) && (ball.y - ball.r < board.y + board.h);
        
        if (between_x && between_y){
            back = -1.5*back;
            v_y = -1*v_y;
            console.log('我撞上板了');
        }
        if (distances(boardket.x1,boardket.y1) < ball.r*ball.r){connerCollision.c1 = ture};
        if (distance(boardket.x2,boardket.y2) < ball.r*ball.r){connerCollision.c2 = ture};

        if ((connerCollision.c1) || (connerCollision.c2)){
            back = -1.5*back;
            v_y = -1*v_y
        }

        
        
    }



    //----------------------------------------//
    //----------------------------------------//
    //----------------开始表演!!!!-------------//
    //----------------------------------------//
    //----------------------------------------//
    var ball_img = new Image();
    ball_img.src = "ball.png";
    ball_img.onload = function () {
        //width = ball_img.width;
        //height = ball_img.height;
        setInterval(function () {
            context.clearRect(0, 0, 1500, 700);

            if (!gamebegin){begin_interface();}//游戏开始界面
            else if (gamebegin && !gameover){
                context.save();
                //数据显示
                context.font = "20px Arial";
                context.fillStyle ="black";
                context.fillText("ball.y: "+ball.y,20,20);
                context.fillText("v_y: "+v_y,20,120);
                context.fillText("台风风向→: "+wind_v,120,120);
                //context.fillText("p_word: "+p_word+
                //"\t p_exist:"+p_exist,220,20);
                t_i = 60-Math.ceil(t/180 );
            
                {//给界面加一个整数计时器。
                t_itotal = t_i + t_iplus;
                context.fillText("时间:" + t_itotal,20,200) ;
                context.fillText("距离" + p_distance,100,200) ;
                }
                //判断游戏结束
                if (t_itotal<=0){
                    gameover=true;
                    //console.log("game over");
                }
                {//篮球架
                context.beginPath();
                context.moveTo(500,200);
                context.lineTo(500,400);
                context.lineTo(525,400);
                context.lineTo(525,200);
                context.closePath();
                context.stroke();          
                }
                {//打包代码运行处

                //篮球特效
                ghost();//篮球残影
                shadow();//篮球影子
                ball_rotate();//篮球旋转
                //篮球运动
                BBU();//篮球弹跳
                level_move();//篮球水平移动

                collision();//碰撞
                //道具
                prop_clock();//闹钟道具
                prop_wind();//台风
                }
                t++;//时间增加

                context.restore();
            }
            else {end_interface();}//游戏结束界面
        
        }, 1000 *1/ (60*3));
        

    }


</script>
</body>
</html>
